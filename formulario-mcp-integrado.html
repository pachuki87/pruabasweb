<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Evaluación - Instituto Lidera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg text-white py-8">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-center">Formulario de Evaluación con IA</h1>
            <p class="text-center mt-2">Procesado con Gemini API</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <form name="preguntas-abiertas-mcp" method="POST" data-netlify="true" class="space-y-6">
            <input type="hidden" name="form-name" value="preguntas-abiertas-mcp" />

            <!-- Información del estudiante -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Información Personal</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
                        <input type="text" id="nombre" name="nombre" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Correo Electrónico</label>
                        <input type="email" id="email" name="email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>

            <!-- Preguntas abiertas -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Preguntas de Desarrollo</h2>

                <div class="space-y-6">
                    <div>
                        <label for="pregunta1" class="block text-sm font-medium text-gray-700 mb-2">
                            1. ¿Qué significa para usted ser adicto y cuáles considera que son las principales características de una conducta adictiva?
                        </label>
                        <textarea id="pregunta1" name="pregunta1" rows="4" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <div>
                        <label for="pregunta2" class="block text-sm font-medium text-gray-700 mb-2">
                            2. Describa las principales consecuencias que las adicciones pueden tener en la vida de una persona y su entorno familiar.
                        </label>
                        <textarea id="pregunta2" name="pregunta2" rows="4" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <div>
                        <label for="pregunta3" class="block text-sm font-medium text-gray-700 mb-2">
                            3. ¿Qué role considera que juega la familia en el proceso de recuperación de una persona con adicciones?
                        </label>
                        <textarea id="pregunta3" name="pregunta3" rows="4" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <div>
                        <label for="pregunta4" class="block text-sm font-medium text-gray-700 mb-2">
                            4. Explique cómo el mindfulness puede ser una herramienta útil en el tratamiento de conductas adictivas.
                        </label>
                        <textarea id="pregunta4" name="pregunta4" rows="4" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
            </div>

            <!-- Botón de envío -->
            <div class="text-center">
                <button type="submit" id="submitBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 transform hover:scale-105">
                    Enviar Respuestas
                </button>
            </div>
        </form>

        <!-- Indicador de progreso -->
        <div id="loadingIndicator" class="hidden mt-4 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600 mb-2">Procesando respuestas con IA...</p>
            <div class="flex justify-center space-x-4 text-sm text-gray-500">
                <span id="statusNetlify">📤 Enviando a Netlify...</span>
                <span id="statusGemini">💎 Procesando con Gemini...</span>
            </div>
        </div>

        <!-- Resultados -->
        <div id="resultados" class="hidden mt-6 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-green-600">¡Evaluación Completada!</h2>
            <p class="text-gray-700 mb-4">Tus respuestas han sido evaluadas usando IA avanzada. Aquí está la retroalimentación:</p>
            <div id="correcciones" class="space-y-4"></div>
        </div>

        <!-- Log de procesamiento -->
        <div id="processingLog" class="hidden mt-4 bg-gray-100 rounded-lg p-4">
            <h3 class="font-semibold text-gray-800 mb-2">Log de Procesamiento:</h3>
            <div id="logContent" class="text-sm text-gray-600 font-mono space-y-1"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[name="preguntas-abiertas-mcp"]');
            const submitBtn = document.getElementById('submitBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultados = document.getElementById('resultados');
            const correcciones = document.getElementById('correcciones');
            const processingLog = document.getElementById('processingLog');
            const logContent = document.getElementById('logContent');

            // Status indicators
            const statusNetlify = document.getElementById('statusNetlify');
            const statusGemini = document.getElementById('statusGemini');

            function log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> <span class="text-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}">${message}</span>`;
                logContent.appendChild(logEntry);
                console.log(`[${timestamp}] ${message}`);
            }

            function updateStatus(service, status, text = '') {
                const element = document.getElementById(`status${service}`);
                if (element) {
                    element.className = status === 'success' ? 'text-green-600' : status === 'error' ? 'text-red-600' : 'text-blue-600';
                    element.textContent = text;
                }
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Resetear estados
                submitBtn.disabled = true;
                submitBtn.textContent = 'Procesando...';
                loadingIndicator.classList.remove('hidden');
                resultados.classList.add('hidden');
                processingLog.classList.remove('hidden');
                logContent.innerHTML = '';

                updateStatus('Netlify', 'pending', '📤 Enviando a Netlify...');
                updateStatus('Gemini', 'pending', '💎 Esperando...');

                const formData = new FormData(form);
                const data = Object.fromEntries(formData);

                try {
                    log('Iniciando procesamiento del formulario...');

                    // 1. Enviar a Netlify Forms (siguiendo el ejemplo exacto de la documentación)
                    log('Enviando datos a Netlify Forms...');
                    updateStatus('Netlify', 'processing', '📤 Enviando a Netlify...');

                    // Según la documentación de Netlify, usar el método recomendado
                    const netlifyResponse = await fetch('/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams(formData).toString()
                    });

                    if (!netlifyResponse.ok) {
                        throw new Error(`Error HTTP: ${netlifyResponse.status}`);
                    }

                    log('✅ Datos enviados a Netlify Forms');
                    updateStatus('Netlify', 'success', '✅ Enviado a Netlify');

                    // 2. Procesar con Gemini API
                    log('Iniciando procesamiento con Gemini API...');
                    const correccionData = await procesarConGemini(data);

                    // 3. Enviar correo con resultados (simulado)
                    log('Enviando resultados por correo...');
                    await enviarCorreoResultados(data.email, data.nombre, correccionData);

                    // 4. Almacenar datos en sistema de respaldo
                    log('Almacenando datos en sistema de respaldo...');
                    await almacenarDatosEnGemini(data, correccionData);

                    // Mostrar resultados
                    log('✅ Procesamiento completado', 'success');
                    mostrarResultados(correccionData);

                } catch (error) {
                    log(`❌ Error: ${error.message}`, 'error');
                    console.error('Error:', error);
                    alert('Hubo un error al procesar tus respuestas. Por favor intenta nuevamente.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Enviar Respuestas';
                    loadingIndicator.classList.add('hidden');
                }
            });

            // Función simplificada para procesar solo con Gemini
            async function procesarConGemini(data) {
                try {
                    updateStatus('Gemini', 'processing', '💎 Procesando con Gemini...');

                    // Construir el prompt con las respuestas del usuario
                    let preguntasTexto = '';
                    const preguntas = [
                        { id: 'pregunta1', texto: '¿Qué significa para usted ser adicto y cuáles considera que son las principales características de una conducta adictiva?' },
                        { id: 'pregunta2', texto: 'Describa las principales consecuencias que las adicciones pueden tener en la vida de una persona y su entorno familiar.' },
                        { id: 'pregunta3', texto: '¿Qué role considera que juega la familia en el proceso de recuperación de una persona con adicciones?' },
                        { id: 'pregunta4', texto: 'Explique cómo el mindfulness puede ser una herramienta útil en el tratamiento de conductas adictivas.' }
                    ];

                    preguntas.forEach((pregunta, index) => {
                        const respuesta = data[pregunta.id] || '';
                        preguntasTexto += `
Pregunta ${index + 1}: ${pregunta.texto}
Respuesta del estudiante: ${respuesta}

`;
                    });

                    const payload = {
                        nombre: data.nombre,
                        email: data.email,
                        quizData: {
                            titulo: 'Evaluación de Adicciones',
                            preguntas: preguntas
                        },
                        userAnswers: {
                            pregunta1: { textoRespuesta: data.pregunta1 },
                            pregunta2: { textoRespuesta: data.pregunta2 },
                            pregunta3: { textoRespuesta: data.pregunta3 },
                            pregunta4: { textoRespuesta: data.pregunta4 }
                        }
                    };

                    log('Enviando solicitud a Gemini API via Netlify function...');

                    const response = await fetch('/.netlify/functions/gemini-api', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    log(`Respuesta Gemini recibida: ${JSON.stringify(result).substring(0, 100)}...`);

                    updateStatus('Gemini', 'success', '✅ Gemini completado');
                    log('✅ Gemini API procesamiento completado', 'success');

                    return parseGeminiResponse(result);

                } catch (error) {
                    log(`Error con Gemini API: ${error.message}`, 'error');
                    updateStatus('Gemini', 'error', '❌ Gemini falló');

                    // Fallback a simulación si Gemini falla
                    log('Usando resultado simulado como fallback', 'error');
                    return getResultadoSimulado(data);
                }
            }

            function parseResponseManual(responseText) {
                const result = {
                    pregunta1: { correccion: '', puntuacion: 7, sugerencias: [] },
                    pregunta2: { correccion: '', puntuacion: 7, sugerencias: [] },
                    pregunta3: { correccion: '', puntuacion: 7, sugerencias: [] },
                    pregunta4: { correccion: '', puntuacion: 7, sugerencias: [] },
                    resumen: responseText
                };

                const patterns = {
                    pregunta1: /pregunta\s*1[:\s]*(.*?)(?=pregunta\s*2|$)/si,
                    pregunta2: /pregunta\s*2[:\s]*(.*?)(?=pregunta\s*3|$)/si,
                    pregunta3: /pregunta\s*3[:\s]*(.*?)(?=pregunta\s*4|$)/si,
                    pregunta4: /pregunta\s*4[:\s]*(.*?)(?=resumen|$)/si,
                    resumen: /resumen[:\s]*(.*?)$/si
                };

                Object.entries(patterns).forEach(([key, pattern]) => {
                    const match = responseText.match(pattern);
                    if (match) {
                        if (key === 'resumen') {
                            result.resumen = match[1].trim();
                        } else {
                            result[key].correccion = match[1].trim();
                            const scoreMatch = match[1].match(/puntuación[:\s]*(\d+)/i);
                            if (scoreMatch) {
                                result[key].puntuacion = parseInt(scoreMatch[1]);
                            }
                        }
                    }
                });

                return result;
            }

            function parseGeminiResponse(geminiData) {
                if (geminiData.evaluations) return geminiData.evaluations;
                if (geminiData.result && geminiData.result.evaluations) return geminiData.result.evaluations;
                if (geminiData.correcciones) return geminiData;

                const content = geminiData.content || geminiData.result || JSON.stringify(geminiData);
                return parseResponseManual(content);
            }

            function getResultadoSimulado(data) {
                log('Generando resultado simulado como fallback');

                return {
                    pregunta1: {
                        correccion: "Buena conceptualización. Considera ampliar sobre la pérdida de control como característica clave.",
                        puntuacion: 8,
                        sugerencias: ["Profundiza en aspectos neurobiológicos"]
                    },
                    pregunta2: {
                        correccion: "Respuesta completa. Podrías mencionar también las consecuencias laborales y sociales.",
                        puntuacion: 9,
                        sugerencias: ["Incluye impacto en salud mental"]
                    },
                    pregunta3: {
                        correccion: "Excelente análisis del rol familiar. Considera incluir los límites saludables.",
                        puntuacion: 9,
                        sugerencias: ["Menciona tipos de intervenciones familiares"]
                    },
                    pregunta4: {
                        correccion: "Buen entendimiento del mindfulness. Sería útil mencionar técnicas específicas.",
                        puntuacion: 8,
                        sugerencias: ["Incluye evidencia científica"]
                    },
                    resumen: "Tu desempeño general es muy bueno (8.5/10). Muestras un sólido entendimiento de los conceptos fundamentales en el estudio de las adicciones."
                };
            }

            async function enviarCorreoResultados(email, nombre, correcciones) {
                log(`Simulando envío de correo a ${email}`);

                // Aquí se integraría con el backend para enviar correos
                await new Promise(resolve => setTimeout(resolve, 1000));
                log('✅ Correo simulado enviado', 'success');
            }

            async function almacenarDatosEnGemini(data, correcciones) {
                try {
                    log('Almacenando datos en sistema de respaldo...');

                    const payload = {
                        type: 'data_store',
                        collection: 'form_submissions',
                        data: {
                            ...data,
                            evaluation: correcciones,
                            processedAt: new Date().toISOString(),
                            status: 'processed'
                        }
                    };

                    const response = await fetch('/.netlify/functions/process-form', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        log('✅ Datos almacenados en sistema de respaldo', 'success');
                    } else {
                        log(`⚠️ Advertencia al almacenar datos: ${response.status}`, 'error');
                    }

                } catch (error) {
                    log(`Error almacenando datos: ${error.message}`, 'error');
                }
            }

            function mostrarResultados(datosCorrecciones) {
                correcciones.innerHTML = '';

                Object.entries(datosCorrecciones).forEach(([key, value]) => {
                    if (key === 'resumen') return;

                    const div = document.createElement('div');
                    div.className = 'border-l-4 border-blue-500 pl-4 py-2';
                    div.innerHTML = `
                        <h3 class="font-semibold text-gray-800">Pregunta ${key.slice(-1)}</h3>
                        <p class="text-gray-700 mt-1">${value.correccion}</p>
                        ${value.sugerencias && value.sugerencias.length > 0 ? `
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-600">Sugerencias:</p>
                                <ul class="text-sm text-gray-600 mt-1">
                                    ${value.sugerencias.map(s => `<li class="flex items-start"><span class="mr-2">•</span>${s}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="mt-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Puntuación: ${value.puntuacion}/10
                            </span>
                        </div>
                    `;
                    correcciones.appendChild(div);
                });

                // Añadir resumen
                if (datosCorrecciones.resumen) {
                    const resumenDiv = document.createElement('div');
                    resumenDiv.className = 'mt-6 p-4 bg-blue-50 rounded-lg';
                    resumenDiv.innerHTML = `
                        <h3 class="font-semibold text-blue-800 mb-2">Resumen General</h3>
                        <p class="text-blue-700">${datosCorrecciones.resumen}</p>
                    `;
                    correcciones.appendChild(resumenDiv);
                }

                resultados.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>